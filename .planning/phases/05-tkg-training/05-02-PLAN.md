---
phase: 05-tkg-training
plan: 02
type: execute
---

<objective>
Implement CPU-optimized RE-GCN model without DGL dependency.

Purpose: Create a working RE-GCN implementation that runs on CPU without requiring DGL, replacing the current baseline frequency model.
Output: Functional RE-GCN model in PyTorch that can learn temporal patterns from knowledge graphs.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-tkg-training/05-CONTEXT.md
@.planning/phases/05-tkg-training/05-RESEARCH.md
@.planning/phases/05-tkg-training/05-01-SUMMARY.md
@src/forecasting/tkg_models/regcn_wrapper.py
@src/forecasting/tkg_models/data_adapter.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement RE-GCN core architecture</name>
  <files>src/training/models/regcn_cpu.py</files>
  <action>
  Create CPU-optimized RE-GCN model using pure PyTorch (no DGL). Based on research, implement:

  Core components:
  - EntityEmbedding: nn.Embedding for entities (embedding_dim=200)
  - RelationEmbedding: nn.Embedding for relations*2 (forward + inverse)
  - TemporalEncoder: GRU to capture temporal evolution (num_layers=2)
  - GraphConvolution: Manual implementation using torch.sparse or adjacency matrices
  - ConvTransE decoder: For link prediction scoring

  Forward pass:
  - Process graph snapshots sequentially through GRU
  - Apply graph convolution at each timestep
  - Output entity embeddings evolved through time

  Use torch.sparse for efficiency on CPU. Include margin-based loss function.
  </action>
  <verify>python -c "from src.training.models.regcn_cpu import REGCN; model = REGCN(100, 50, 200); print('Model initialized')"</verify>
  <done>RE-GCN model architecture implemented</done>
</task>

<task type="auto">
  <name>Task 2: Create training utilities</name>
  <files>src/training/train_utils.py</files>
  <action>
  Implement training utilities for the RE-GCN model:

  - create_graph_snapshots(events_df, num_snapshots=30): Split temporal events into snapshots
  - build_adjacency_matrix(snapshot): Convert events to sparse adjacency matrix
  - negative_sampling(positive_triples, num_negatives=10): Generate negative samples
  - compute_mrr(predictions, ground_truth): Mean Reciprocal Rank metric
  - save_checkpoint(model, path): Save model state
  - load_checkpoint(path): Load saved model

  Focus on memory efficiency - process snapshots one at a time, use sparse tensors where possible.
  </action>
  <verify>python -c "from src.training.train_utils import create_graph_snapshots, compute_mrr; print('Utils imported successfully')"</verify>
  <done>Training utilities created</done>
</task>

<task type="auto">
  <name>Task 3: Update RE-GCN wrapper to use new model</name>
  <files>src/forecasting/tkg_models/regcn_wrapper.py</files>
  <action>
  Update the REGCNWrapper to use our CPU implementation instead of always falling back to baseline:

  In _initialize_model():
  - Import our regcn_cpu module
  - Initialize REGCN model with proper dimensions
  - Set self.use_baseline = False when successful

  In fit():
  - Implement actual training using our model
  - Convert quadruples to graph snapshots
  - Train for specified epochs (default 100)
  - Show training progress

  In prediction methods:
  - Use trained model for predictions instead of frequency baseline
  - Forward pass through model to get scores

  Keep baseline as fallback if import fails.
  </action>
  <verify>grep -n "use_baseline = False" src/forecasting/tkg_models/regcn_wrapper.py</verify>
  <done>RE-GCN wrapper updated to use CPU implementation</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] RE-GCN model can be initialized without DGL
- [ ] Training utilities import successfully
- [ ] REGCNWrapper can use the new model
- [ ] No DGL import errors
</verification>

<success_criteria>
- All tasks completed
- RE-GCN architecture implemented in pure PyTorch
- Model can process graph snapshots
- Wrapper integration complete
</success_criteria>

<output>
After completion, create `.planning/phases/05-tkg-training/05-02-SUMMARY.md`:

# Phase 5 Plan 2: RE-GCN Implementation Summary

**Implemented CPU-optimized RE-GCN without DGL dependency**

## Accomplishments

- Pure PyTorch RE-GCN architecture
- Graph convolution without DGL
- Training utilities for temporal graphs
- Wrapper integration complete

## Files Created/Modified

- `src/training/models/regcn_cpu.py` - RE-GCN model
- `src/training/train_utils.py` - Training utilities
- `src/forecasting/tkg_models/regcn_wrapper.py` - Updated wrapper

## Next Step

Ready for 05-03-PLAN.md (Training pipeline)
</output>