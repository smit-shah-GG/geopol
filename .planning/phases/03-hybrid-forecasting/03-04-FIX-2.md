---
phase: 03-hybrid-forecasting
plan: 03-04-FIX-2
type: fix
---

<objective>
Fix remaining schema issues after first round of UAT fixes.

Source: New issues discovered after 03-04-FIX execution
Priority: 1 blocker (Gemini API schema validation)
Purpose: Fix empty properties in object types that Gemini API requires
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md

**Previous fix:**
@.planning/phases/03-hybrid-forecasting/03-04-FIX-SUMMARY.md

**Key affected files:**
@src/forecasting/models.py
</context>

<tasks>

<task type="auto">
  <name>Fix empty object properties in Gemini schema</name>
  <files>src/forecasting/models.py</files>
  <action>
    Fix the empty properties error for object types in the Gemini schema. Gemini requires that any field with "type": "object" must have at least one property defined.

    Current issues in get_scenario_schema() and get_scenario_tree_schema():
    1. metadata field has {"type": "object"} with no properties
    2. Entity.attributes field has {"type": "object"} with no properties

    Solution:
    1. In get_scenario_schema():
       - Find Entity attributes field (around line 170)
       - Change from {"type": "object"} to:
         {"type": "object", "properties": {"category": {"type": "string"}, "confidence": {"type": "number"}}}

    2. In get_scenario_tree_schema():
       - Find metadata field (around line 197)
       - Change from {"type": "object"} to:
         {"type": "object", "properties": {"generated_at": {"type": "string"}, "model": {"type": "string"}, "context_count": {"type": "integer"}}}

    These properties are meaningful and can be used to track:
    - Entity attributes: category (e.g., "military", "economic") and confidence scores
    - Metadata: when generated, which model was used, how much context was provided

    This preserves the fields while satisfying Gemini's requirement for non-empty object properties.
  </action>
  <verify>uv run python forecast.py "Will there be a conflict?" --output-format summary 2>&1 | grep -v "empty for OBJECT type"</verify>
  <done>No more "should be non-empty for OBJECT type" errors from Gemini API</done>
</task>

<task type="auto">
  <name>Update scenario parser to handle new metadata properties</name>
  <files>src/forecasting/scenario_generator.py</files>
  <action>
    Update the scenario generation and parsing to populate the new metadata properties.

    In ScenarioGenerator._generate_structured():
    1. After receiving the Gemini response, ensure metadata is populated
    2. Add generated_at: current ISO timestamp
    3. Add model: "gemini-1.5-flash" (or from self.client.model if available)
    4. Add context_count: len(context) if context else 0

    In ScenarioGenerator._parse_scenario_tree():
    1. Handle both old format (empty metadata) and new format gracefully
    2. If metadata is missing these fields, add defaults:
       - generated_at: datetime.now().isoformat()
       - model: "unknown"
       - context_count: 0

    This ensures backward compatibility while populating meaningful metadata.
  </action>
  <verify>uv run python -c "from src.forecasting.scenario_generator import ScenarioGenerator; sg = ScenarioGenerator(); print('Generator ready with metadata support')"</verify>
  <done>Metadata properly populated in generated scenarios</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Gemini API accepts schema without "empty properties" errors
- [ ] forecast.py generates predictions successfully
- [ ] Metadata is populated with meaningful values
- [ ] Entity attributes structure is preserved
- [ ] Backward compatibility maintained
</verification>

<success_criteria>
- Empty object properties issue resolved
- Gemini API generates structured output successfully
- CLI produces forecasts without schema errors
- Metadata and attributes preserved with meaningful properties
</success_criteria>

<output>
After completion, create `.planning/phases/03-hybrid-forecasting/03-04-FIX-2-SUMMARY.md`:

# Phase 3 Plan 4 Fix Round 2: Schema Properties Summary

**Fixed Gemini API empty object properties while preserving metadata functionality**

## Issues Fixed

- Empty properties for object types in Gemini schema
- Added meaningful properties to metadata and attributes fields

## Files Modified

- `src/forecasting/models.py` - Added properties to object types
- `src/forecasting/scenario_generator.py` - Populate metadata properties

## Technical Solution

Preserved fields by adding meaningful properties:
- Entity.attributes: category and confidence tracking
- ScenarioTree.metadata: generation timestamp, model used, context count

## Ready for Testing

Run `python forecast.py "test question"` to verify full functionality.
</output>