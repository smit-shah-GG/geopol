---
phase: 03-hybrid-forecasting
plan: 03-04-FIX
type: fix
---

<objective>
Fix 3 UAT issues from plan 03-04.

Source: 03-04-ISSUES.md
Priority: 1 blocker, 1 major, 1 minor
Purpose: Resolve Gemini API schema compatibility, entity extraction, and .env loading issues
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md

**Issues being fixed:**
@.planning/phases/03-hybrid-forecasting/03-04-ISSUES.md

**Original plan for reference:**
@.planning/phases/03-hybrid-forecasting/03-04-PLAN.md

**Key affected files:**
@src/forecasting/models.py
@src/forecasting/ensemble_predictor.py
@forecast.py
</context>

<tasks>

<task type="auto">
  <name>Fix UAT-001: Remove additionalProperties from Gemini API schema</name>
  <files>src/forecasting/models.py, src/forecasting/scenario_generator.py</files>
  <action>
    Fix the ScenarioTree.to_gemini_schema() method that generates JSON schema for Gemini API.
    Current issue: Line 195 uses "additionalProperties" which Gemini API doesn't support.

    Solution:
    1. In models.py ScenarioTree.to_gemini_schema(), remove the "additionalProperties" field
    2. Instead, explicitly define the scenarios as an array with items schema
    3. Update schema to use "properties" with explicit scenario array structure
    4. In scenario_generator.py, update any references to handle the new schema format
    5. Ensure the schema only uses Gemini-supported JSON Schema features

    The fixed schema should define scenarios as:
    "properties": {
      "scenarios": {
        "type": "array",
        "items": scenario_schema
      }
    }
  </action>
  <verify>python forecast.py "Will there be a cyberattack?" --output-format summary runs without "additionalProperties" error</verify>
  <done>Gemini API accepts the schema and generates structured output successfully</done>
</task>

<task type="auto">
  <name>Fix UAT-002: Improve entity extraction for TKG queries</name>
  <files>src/forecasting/ensemble_predictor.py, tests/test_ensemble.py</files>
  <action>
    Fix entity extraction logic in EnsemblePredictor that's causing test failures.

    Issue: TKG predictions fail with "Insufficient entities for TKG query" even when entities exist.

    Solution:
    1. In ensemble_predictor.py, review _extract_entities_from_llm() method
    2. Ensure it properly extracts entity names from scenario descriptions
    3. Handle edge cases: single entity scenarios, entities in different formats
    4. Update entity extraction to be more robust (look for capitalized words, known patterns)
    5. Add fallback: if < 2 entities found, try extracting from question text as well
    6. Ensure tests in test_ensemble.py pass for entity extraction scenarios

    The logic should successfully extract entities from various scenario formats and handle edge cases gracefully.
  </action>
  <verify>pytest tests/test_ensemble.py::TestEntityExtraction -v passes all tests</verify>
  <done>All 3 failing entity extraction tests now pass</done>
</task>

<task type="auto">
  <name>Fix UAT-003: Add automatic .env file loading</name>
  <files>forecast.py, requirements.txt</files>
  <action>
    Add python-dotenv to automatically load .env files when forecast.py runs.

    Solution:
    1. Add python-dotenv to requirements.txt
    2. At the top of forecast.py (after imports), add:
       from dotenv import load_dotenv
       load_dotenv()  # Load .env file if it exists
    3. This should be before any os.getenv() calls
    4. Maintain backward compatibility - still support explicit GEMINI_API_KEY env var
    5. Document in help text that .env file is automatically loaded

    This ensures users don't need to manually export environment variables.
  </action>
  <verify>With .env file containing GEMINI_API_KEY, running python forecast.py "test" finds the API key</verify>
  <done>.env file automatically loads, no need for manual export</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Gemini API schema error resolved (blocker fixed)
- [ ] Entity extraction tests pass (major fixed)
- [ ] .env file auto-loads (minor fixed)
- [ ] forecast.py works end-to-end with a test question
- [ ] All original acceptance criteria from issues met
</verification>

<success_criteria>
- All UAT issues from 03-04-ISSUES.md addressed
- Tests pass (especially entity extraction tests)
- CLI works without manual environment variable export
- Gemini API accepts schema and generates predictions
- Ready for re-verification with /gsd:verify-work
</success_criteria>

<output>
After completion, create `.planning/phases/03-hybrid-forecasting/03-04-FIX-SUMMARY.md`:

# Phase 3 Plan 4 Fix: UAT Issues Summary

**Fixed Gemini API schema compatibility, entity extraction, and environment loading**

## Issues Fixed

- UAT-001 (Blocker): Removed additionalProperties from Gemini schema
- UAT-002 (Major): Improved entity extraction for TKG queries
- UAT-003 (Minor): Added automatic .env file loading

## Files Modified

- `src/forecasting/models.py` - Fixed Gemini schema generation
- `src/forecasting/scenario_generator.py` - Updated for new schema
- `src/forecasting/ensemble_predictor.py` - Improved entity extraction
- `forecast.py` - Added dotenv loading
- `requirements.txt` - Added python-dotenv

## Testing

- Gemini API now accepts schema without errors
- Entity extraction tests pass (3 previously failing)
- .env file loads automatically

## Ready for Re-verification

Run `/gsd:verify-work 03-04` to confirm all issues resolved.
</output>