---
phase: 03-hybrid-forecasting
plan: 04
type: execute
---

<objective>
Build ensemble layer and command-line interface for hybrid forecasting.

Purpose: Combine TKG and LLM predictions into unified forecasts with explainable reasoning chains.
Output: Working CLI that accepts geopolitical questions and returns structured predictions.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-hybrid-forecasting/03-RESEARCH.md
@.planning/phases/03-hybrid-forecasting/03-01-SUMMARY.md
@.planning/phases/03-hybrid-forecasting/03-02-SUMMARY.md
@.planning/phases/03-hybrid-forecasting/03-03-SUMMARY.md
@src/forecasting/reasoning_orchestrator.py
@src/forecasting/tkg_predictor.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement ensemble predictor with weighted voting</name>
  <files>src/forecasting/ensemble_predictor.py, tests/test_ensemble.py</files>
  <action>Create EnsemblePredictor class that combines LLM and TKG predictions. Implement weighted voting with configurable alpha (default 0.6 for LLM, 0.4 for TKG based on research). For each prediction: normalize probability distributions, apply weights, combine into final forecast. Track component contributions for explainability. Add confidence calibration using temperature scaling. Implement fallback when one model fails (use other with notification). Create test verifying ensemble performs better than individual models on synthetic examples.</action>
  <verify>python -m pytest tests/test_ensemble.py -v passes all tests</verify>
  <done>EnsemblePredictor combines predictions with proper weighting and calibration</done>
</task>

<task type="auto">
  <name>Task 2: Create unified forecasting interface</name>
  <files>src/forecasting/forecast_engine.py, src/forecasting/output_formatter.py</files>
  <action>Implement ForecastEngine as main entry point combining all components: ReasoningOrchestrator (LLM), TKGPredictor (graph), RAGPipeline (grounding), EnsemblePredictor (combination). Create forecast() method accepting natural language questions. Build OutputFormatter that structures results: main prediction (probability, timeframe), scenario tree (top 3 scenarios), reasoning chain (step-by-step logic), supporting evidence (graph patterns, historical precedents), confidence metrics. Format as JSON with option for human-readable text.</action>
  <verify>python -c "from src.forecasting.forecast_engine import ForecastEngine; engine = ForecastEngine(); result = engine.forecast('Will Russia-Ukraine conflict escalate?'); print('Forecast generated')" runs without error</verify>
  <done>Unified forecasting interface orchestrates all components</done>
</task>

<task type="auto">
  <name>Task 3: Build CLI for forecasting queries</name>
  <files>forecast.py, tests/test_cli.py</files>
  <action>Create forecast.py CLI using argparse. Arguments: question (required), --output-format (json/text, default text), --verbose (show reasoning steps), --no-cache (bypass RAG cache), --weights (custom ensemble weights). Load API key from GEMINI_API_KEY environment variable. Initialize ForecastEngine with all components. Display results with clear formatting: prediction percentage, key scenarios, reasoning summary. Add error handling for API failures with helpful messages. Create test verifying CLI argument parsing and output formatting.</action>
  <verify>python forecast.py "Will China-Taiwan tensions escalate?" --verbose produces formatted output</verify>
  <done>CLI provides user-friendly interface to forecasting system</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] Ensemble combines predictions effectively
- [ ] Forecast engine integrates all components
- [ ] CLI accepts questions and returns predictions
- [ ] Reasoning chains are clear and traceable
- [ ] Output includes probabilities and explanations
- [ ] Phase 3 complete
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Ensemble predictor operational
- Unified forecasting interface working
- CLI successfully processes queries
- Full reasoning chains preserved
- Phase 3: Hybrid Forecasting complete
</success_criteria>

<output>
After completion, create `.planning/phases/03-hybrid-forecasting/03-04-SUMMARY.md`:

# Phase 3 Plan 4: Ensemble and CLI Summary

**Completed hybrid forecasting system with ensemble predictions and CLI interface**

## Accomplishments

- Implemented weighted ensemble combining LLM and TKG predictions
- Created unified forecasting interface orchestrating all components
- Built command-line interface for geopolitical queries
- Preserved explainable reasoning chains throughout

## Files Created/Modified

- `src/forecasting/ensemble_predictor.py` - Weighted voting ensemble
- `src/forecasting/forecast_engine.py` - Main forecasting interface
- `src/forecasting/output_formatter.py` - Result formatting
- `forecast.py` - Command-line interface
- `tests/test_ensemble.py` - Ensemble tests
- `tests/test_cli.py` - CLI tests

## Decisions Made

- Default weights: 0.6 LLM, 0.4 TKG (configurable)
- Temperature scaling for confidence calibration
- JSON and text output formats supported
- Graceful degradation if one model fails

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Phase 3 complete, ready for Phase 4: Calibration & Evaluation
</output>