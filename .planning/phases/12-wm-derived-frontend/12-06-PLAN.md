---
phase: 12-wm-derived-frontend
plan: 06
type: execute
wave: 4
depends_on: ["12-01", "12-02", "12-05"]
files_modified:
  - frontend/src/components/CountryBriefPage.ts
autonomous: true

must_haves:
  truths:
    - "Clicking a country on the globe opens a full-screen Country Brief modal"
    - "Country Brief has 7 tabs: Overview, Active Forecasts, GDELT Events, Risk Signals, Forecast History, Entity Relations, and Calibration"
    - "Overview tab shows risk score, top forecast, recent events summary, and calibration snapshot in one synthesized view"
    - "Active Forecasts tab shows probability bars with expandable scenario trees"
    - "Risk Signals tab shows CAMEO category breakdown with event frequency and Goldstein scale indicators"
    - "Calibration tab shows reliability diagram and Brier score decomposition"
    - "Entity Relations tab has toggle between force-directed graph and table view"
  artifacts:
    - path: "frontend/src/components/CountryBriefPage.ts"
      provides: "Full-screen tabbed modal for country details with 7 tabs"
      contains: "class CountryBriefPage"
      min_lines: 350
  key_links:
    - from: "frontend/src/components/CountryBriefPage.ts"
      to: "frontend/src/services/forecast-client.ts"
      via: "forecastClient.getForecastsByCountry()"
      pattern: "forecastClient"
    - from: "frontend/src/components/CountryBriefPage.ts"
      to: "'country-selected' CustomEvent"
      via: "window.addEventListener listener"
      pattern: "country-selected"
    - from: "frontend/src/components/CountryBriefPage.ts"
      to: "d3"
      via: "d3-force for entity graph, d3-shape/SVG for calibration chart"
      pattern: "d3\\.force|d3\\.hierarchy"
---

<objective>
Build the Country Brief Page: a full-screen tabbed modal that opens when a country is clicked on the globe. Contains 7 tabs: Overview, Active Forecasts, GDELT Events, Risk Signals, Forecast History, Entity Relations, and Calibration. This is the deepest data exploration surface in the dashboard.

Purpose: FE-06 -- the country-specific drill-down. Users click a country on the globe and see everything the system knows about it: active forecasts, event history, risk signals by CAMEO category, entity relationships, and calibration quality.

Output: CountryBriefPage component with 7 tabs, each rendering data from the API.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/12-wm-derived-frontend/12-CONTEXT.md
@.planning/phases/12-wm-derived-frontend/12-RESEARCH.md
@.planning/phases/12-wm-derived-frontend/12-01-SUMMARY.md
@.planning/phases/12-wm-derived-frontend/12-02-SUMMARY.md
@.planning/phases/12-wm-derived-frontend/12-05-SUMMARY.md

# WM reference for tab structure:
@/home/kondraki/personal/worldmonitor/src/components/CountryBriefPage.ts

# TypeScript types and service client:
@frontend/src/types/api.ts
@frontend/src/services/forecast-client.ts
@frontend/src/utils/dom-utils.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: CountryBriefPage modal structure + Overview + Active Forecasts + GDELT Events + Risk Signals tabs</name>
  <files>frontend/src/components/CountryBriefPage.ts</files>
  <action>
    Create CountryBriefPage (full file, ~500-600 lines across both tasks -- Task 1 builds the first 4 tabs + modal structure, Task 2 adds the remaining 3). Read WM's CountryBriefPage.ts (677 lines) for the tab structure pattern, but build new content. This is a standalone modal, not a Panel subclass.

    **Modal structure (from WM pattern):**
    - Full-screen overlay (same as ScenarioExplorer): dark backdrop, modal inset 20px
    - Header: country flag emoji + country name + ISO code + risk score badge + close button
    - Tab bar: horizontal tabs below header
    - Tab content area: fills remaining space, scrollable
    - Close on: Escape, backdrop click, X button

    **Tab system:**
    - Private `activeTab: string` state
    - Tab bar rendered with h(): buttons for each tab, active tab gets `tab-active` class
    - Clicking tab calls `switchTab(tabId)` which re-renders tab content
    - Tabs: 'overview' | 'forecasts' | 'events' | 'risk-signals' | 'history' | 'entities' | 'calibration'

    **Data loading:**
    - On open(iso): call `forecastClient.getForecastsByCountry(iso)` and `forecastClient.getCountryRisk(iso)`
    - Store results: `this.forecasts: ForecastResponse[]`, `this.countryRisk: CountryRiskSummary | null`
    - Show loading state while fetching, error state on failure

    **Tab 1 - Overview (default tab):**
    Dashboard-within-a-dashboard layout. Grid of 4 summary cards:
    1. **Risk Score card**: Large number (0-100), color-coded, trend arrow, "last 7 days" label
    2. **Top Forecast card**: Question text, probability bar, confidence badge
    3. **Recent Events card**: placeholder with "GDELT event feed" text and count (mock data for now)
    4. **Calibration Snapshot card**: Brier score value, historical accuracy percentage
    - Each card: surface-hover bg, padding, border-radius
    - This gives an at-a-glance view before drilling into tabs

    **Tab 2 - Active Forecasts:**
    - List of all forecasts for this country (from getForecastsByCountry)
    - Each forecast rendered as an expanded card (more detail than ForecastPanel's compact rows):
      - Full question text
      - Probability bar (full width, labeled)
      - Confidence level badge
      - Scenario count
      - Ensemble breakdown inline (LLM: X% | TKG: Y%)
      - Created/expires timestamps
    - Each card is clickable: dispatches `forecast-selected` event (opens ScenarioExplorer)
    - If no forecasts: "No active forecasts for this country"

    **Tab 3 - GDELT Events:**
    - Placeholder for now (no raw events endpoint exists)
    - Show: "GDELT event data will be available when the ingest daemon is running."
    - Render 5-6 mock event rows demonstrating the layout:
      - Timestamp | Actor1 -> Action -> Actor2 | CAMEO code badge | Goldstein scale bar
    - Ready for real data when an events endpoint is added

    **Tab 4 - Risk Signals (CAMEO categories):**
    - FE-06 requires "Risk Signals (CAMEO categories)" tab
    - Extract CAMEO-related data from forecasts' evidence sources and scenario entities
    - Render a breakdown by CAMEO root category (01-20):
      - Category code + name (e.g. "14 - PROTEST", "19 - FIGHT")
      - Event frequency: count of evidence sources with matching CAMEO codes (or mock counts if data sparse)
      - Average Goldstein scale: color-coded bar (-10 to +10, red for negative, green for positive)
      - Trend indicator: rising/stable/falling based on recent vs historical frequency
    - If no CAMEO data available: render the full CAMEO root category list with zero counts and text "Risk signals populate from GDELT event classification"
    - Display as a compact table with monospace numbers, sorted by frequency descending (non-zero categories first)
    - Include a small legend: "Goldstein scale: -10 (conflict) to +10 (cooperation)"

    **Event handling:**
    - Listen for `country-selected` CustomEvent on window:
      ```typescript
      window.addEventListener('country-selected', (e) => {
        const iso = (e as CustomEvent<{ iso: string }>).detail.iso;
        this.open(iso);
      });
      ```
    - Public `open(iso: string)`: show modal, fetch data, render overview tab
    - Public `close()`: hide modal
    - Public `destroy()`: cleanup

    Leave stub methods for the remaining 3 tabs (renderHistoryTab, renderEntitiesTab, renderCalibrationTab) that Task 2 will implement. Each stub should render a placeholder "Loading..." message so the file compiles.
  </action>
  <verify>
    `cd frontend && npx tsc --noEmit` passes.
    CountryBriefPage class exports open(), close(), destroy() methods.
    Tab bar renders 7 tabs. First 4 tabs have content, last 3 are stubs.
  </verify>
  <done>
    CountryBriefPage modal structure complete with header, 7-tab bar, and close handlers.
    Overview tab renders 4 summary cards.
    Active Forecasts tab renders expandable forecast cards.
    GDELT Events tab renders mock event layout.
    Risk Signals tab renders CAMEO category breakdown with frequency and Goldstein indicators.
    Remaining 3 tabs have stub render methods ready for Task 2.
  </done>
</task>

<task type="auto">
  <name>Task 2: Forecast History + Entity Relations + Calibration tabs</name>
  <files>frontend/src/components/CountryBriefPage.ts</files>
  <action>
    Complete the CountryBriefPage by implementing the remaining 3 tab render methods. This task modifies the same file created in Task 1.

    **Tab 5 - Forecast History:**
    - Line chart showing probability evolution over time (SVG, hand-rolled or d3-shape):
      - X-axis: dates, Y-axis: probability (0-1)
      - One line per forecast question
      - Dots at data points, hover for tooltip
    - Below the chart: scrollable list of past forecasts (same card format as Active Forecasts tab)
    - For now with mock data: show placeholder "History populates as forecasts accumulate"
    - If forecasts exist, plot their probability values as single points (one-time snapshots rather than evolution lines)

    **Tab 6 - Entity Relations:**
    - Toggle button: "Graph View" | "Table View"
    - **Graph View** (default): d3-force simulation
      - Extract entities from all forecasts for this country: collect all `scenario.entities` across all scenarios
      - Build edges: two entities appearing in the same scenario = one edge, weight = scenario.probability
      - Render with d3.forceSimulation():
        - Nodes: entity names as labels, sized by frequency
        - Links: lines connecting co-occurring entities, width proportional to weight
        - Force: center, charge (repel), link (attract connected)
        - SVG container: responsive width, ~400px height
        - Nodes draggable (d3.drag)
      - If no entities: "Entity relationships populate from forecast scenarios"
    - **Table View**: Simple table with columns: Entity | Co-occurs With | Frequency | Avg Probability
      - One row per entity pair
      - Sorted by frequency descending

    **Tab 7 - Calibration:**
    - Reuse the reliability diagram rendering pattern from CalibrationPanel (Plan 04)
    - Show per-country calibration data (from forecast.calibration fields)
    - Reliability diagram: predicted vs observed (same SVG rendering as CalibrationPanel)
    - Brier score decomposition table: Reliability | Resolution | Uncertainty (if data available)
    - Per-CAMEO category accuracy table: Category | Accuracy | Sample Size
    - If no calibration data: "Calibration data populates as predictions resolve"

    **CSS (add to panels.css):**
    - `.country-brief-backdrop`: same as scenario explorer
    - `.country-brief-modal`: fixed inset 20px, flex column
    - `.country-brief-header`: country flag, name, risk badge, close btn
    - `.country-brief-tabs`: horizontal tab bar, uppercase labels
    - `.tab-button`: padding, monospace, border-bottom active indicator
    - `.tab-content`: flex 1, overflow-y auto, padding
    - `.overview-grid`: CSS grid 2x2 for summary cards
    - `.overview-card`: surface-hover bg, padding, border-radius
    - `.forecast-detail-card`: expanded forecast card with full text
    - `.risk-signals-table`: monospace, sortable columns, Goldstein bar
    - `.cameo-category-row`: flex row with category badge, frequency, Goldstein bar
    - `.entity-graph-container svg`: responsive
    - `.entity-table`: monospace, zebra-striped
    - `.view-toggle`: button group for graph/table switch
  </action>
  <verify>
    `cd frontend && npx tsc --noEmit` passes.
    CountryBriefPage class exports open(), close(), destroy() methods.
    All 7 tabs implemented with render methods.
    d3 imports for force simulation compile.
  </verify>
  <done>
    CountryBriefPage complete with all 7 tabs:
    - Overview (summary grid)
    - Active Forecasts (expandable cards)
    - GDELT Events (placeholder with mock layout)
    - Risk Signals (CAMEO category breakdown with frequency + Goldstein)
    - Forecast History (chart + list)
    - Entity Relations (force graph + table toggle)
    - Calibration (reliability diagram + Brier table)
    Forecast cards dispatch 'forecast-selected' for ScenarioExplorer integration.
    Entity Relations has d3-force graph and structured table toggle.
  </done>
</task>

</tasks>

<verification>
- `cd frontend && npx tsc --noEmit` passes
- CountryBriefPage has 7 tabs: overview, forecasts, events, risk-signals, history, entities, calibration
- Modal opens from country-selected event, closes via Escape/backdrop/X
- Tab switching works (re-renders content)
- Risk Signals tab renders CAMEO category breakdown
- Entity Relations tab has d3-force graph view
- Forecast cards in Active Forecasts tab dispatch forecast-selected
</verification>

<success_criteria>
- Full-screen tabbed modal for country details (FE-06)
- 7 tabs including Risk Signals (CAMEO categories) per FE-06 spec
- Overview tab synthesizes risk score + top forecast + events + calibration
- Risk Signals tab shows CAMEO category event frequency and Goldstein breakdown
- Entity Relations tab has force-directed graph (d3-force) and table view toggle
- Calibration tab reuses reliability diagram pattern
- Forecast clicks open ScenarioExplorer
</success_criteria>

<output>
After completion, create `.planning/phases/12-wm-derived-frontend/12-06-SUMMARY.md`
</output>
