---
phase: 12-wm-derived-frontend
plan: 05
type: execute
wave: 3
depends_on: ["12-01", "12-02"]
files_modified:
  - frontend/src/components/ScenarioExplorer.ts
autonomous: true

must_haves:
  truths:
    - "Clicking a forecast card opens ScenarioExplorer as a full-screen modal"
    - "Scenario tree renders as vertical top-down SVG with root question at top and branches expanding downward"
    - "Node circles are sized by probability and colored by affirmative/negative"
    - "Clicking a tree node populates the evidence sidebar with that node's evidence sources"
    - "Evidence sidebar shows source links, descriptions, confidence scores, and GDELT event IDs"
    - "Pressing Escape or clicking backdrop closes the modal"
  artifacts:
    - path: "frontend/src/components/ScenarioExplorer.ts"
      provides: "Full-screen modal with d3-hierarchy tree and evidence sidebar"
      contains: "class ScenarioExplorer"
      min_lines: 200
  key_links:
    - from: "frontend/src/components/ScenarioExplorer.ts"
      to: "d3"
      via: "d3.hierarchy + d3.tree for layout"
      pattern: "d3\\.hierarchy|d3\\.tree"
    - from: "frontend/src/components/ScenarioExplorer.ts"
      to: "'forecast-selected' CustomEvent"
      via: "window.addEventListener listener"
      pattern: "forecast-selected"
---

<objective>
Build the ScenarioExplorer: a full-screen modal that visualizes a forecast's scenario tree using d3-hierarchy. Clicking a forecast card (from ForecastPanel) opens this modal. The tree renders vertically with the root question at top, branches expand downward, node circles are sized by probability. An evidence sidebar to the right shows sources for the selected branch node.

Purpose: This is FE-04 -- the interactive scenario exploration feature. It's the core explainability interface where users drill into WHY a forecast exists.

Output: ScenarioExplorer component that opens as a modal, renders scenario trees with d3, and shows evidence per branch.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/12-wm-derived-frontend/12-CONTEXT.md
@.planning/phases/12-wm-derived-frontend/12-RESEARCH.md
@.planning/phases/12-wm-derived-frontend/12-01-SUMMARY.md

# TypeScript types:
@frontend/src/types/api.ts
@frontend/src/utils/dom-utils.ts
@frontend/src/utils/theme-colors.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: ScenarioExplorer modal with d3 tree + evidence sidebar</name>
  <files>frontend/src/components/ScenarioExplorer.ts</files>
  <action>
    Create the ScenarioExplorer class (~250-350 lines). This is NOT a Panel subclass -- it's a standalone modal component.

    **Modal structure:**
    - Full-screen overlay with dark semi-transparent backdrop (rgba(0,0,0,0.85))
    - Modal container: flex row, 70% tree area + 30% evidence sidebar
    - Header bar: forecast question text + probability badge + close button (X)
    - Close on: Escape keypress, backdrop click, X button click
    - Append to document.body (not inside a panel)

    **Scenario tree rendering (left 70%):**
    - Convert ForecastResponse.scenarios (ScenarioDTO[]) to d3 hierarchy data:
      - Root node: the forecast question
      - Children: top-level scenarios
      - Recursive: ScenarioDTO.child_scenarios
    - Use `d3.hierarchy()` to build hierarchy from the converted data
    - Use `d3.tree().nodeSize([200, 100])` for vertical top-down layout
    - Render to SVG:
      - Compute viewBox from node bounds (min/max x/y + padding)
      - Draw links: `d3.linkVertical()` for curved connecting lines, stroke: var(--border-strong)
      - Draw nodes:
        - Circle: radius = 8 + probability * 20 (capped at 28), filled with:
          - affirmative=true: semantic-critical (red)
          - affirmative=false: semantic-low (blue)
          - Opacity 0.8
        - Label below node: description truncated to 40 chars, font-size 11px, fill: var(--text-secondary)
        - Probability label above node: percentage, font-size 10px, fill: var(--text-dim)
      - Nodes are clickable (cursor: pointer, click handler)
    - Max render depth: 4 levels. If ScenarioDTO has deeper nesting, show "+N deeper" indicator
    - Tree container should be scrollable (overflow: auto) for large trees

    **Evidence sidebar (right 30%):**
    - Fixed position sidebar with border-left separator
    - Default state: "Click a scenario node to view evidence"
    - When a node is clicked, populate with:
      - Scenario description (full text, not truncated)
      - Probability: colored percentage
      - Entities: list of actor names as badges
      - Timeline: ordered list of expected events
      - Evidence sources: one card per EvidenceDTO:
        - Source type badge: "GDELT" (blue), "TKG pattern" (orange), "RAG match" (green)
        - Description text
        - Confidence: progress bar or percentage
        - Timestamp (if present): formatted date
        - GDELT Event ID (if present): monospace, could be a link in future
      - If no evidence_sources: show "No evidence available for this branch"
    - Sidebar scrolls independently of tree

    **Event handling:**
    - Listen for `forecast-selected` CustomEvent on window:
      ```typescript
      window.addEventListener('forecast-selected', (e) => {
        const forecast = (e as CustomEvent<{ forecast: ForecastResponse }>).detail.forecast;
        this.open(forecast);
      });
      ```
    - Public `open(forecast: ForecastResponse)`: show modal, render tree
    - Public `close()`: hide modal, remove from DOM or set display:none
    - Public `destroy()`: remove event listener, remove DOM element

    **CSS (add to panels.css):**
    - `.scenario-explorer-backdrop`: fixed, inset 0, z-index 1000
    - `.scenario-explorer-modal`: fixed, inset 40px, bg surface, border, border-radius, flex row, z-index 1001
    - `.scenario-tree-container`: flex 1, overflow auto, padding
    - `.scenario-evidence-sidebar`: width 30%, min-width 300px, border-left, overflow-y auto, padding
    - `.scenario-header`: flex row, justify between, padding, border-bottom
    - `.evidence-source-card`: surface-hover bg, padding, border-radius, margin-bottom
    - `.source-badge`: small rounded badge with source-type color
    - `.entity-badge`: small inline badge
    - Cursor pointer on nodes
    - Hover effect on nodes (slight glow)
  </action>
  <verify>
    `cd frontend && npx tsc --noEmit` passes.
    ScenarioExplorer class exports open(), close(), destroy() methods.
    d3 imports compile (d3.hierarchy, d3.tree, d3.linkVertical).
  </verify>
  <done>
    ScenarioExplorer opens as full-screen modal on 'forecast-selected' event.
    d3 tree renders scenario tree vertically (root at top).
    Nodes sized by probability, colored by affirmative/negative.
    Clicking a node shows its evidence in the sidebar.
    Close via Escape, backdrop click, or X button.
    Max 4 levels depth, scrollable tree and sidebar.
  </done>
</task>

</tasks>

<verification>
- `cd frontend && npx tsc --noEmit` passes
- ScenarioExplorer imports d3 hierarchy and tree layout functions
- Modal has backdrop, tree area, evidence sidebar, close button
- Tree SVG rendered with d3.tree layout
- Node click populates sidebar with evidence
</verification>

<success_criteria>
- Full-screen modal with scenario tree visualization (FE-04)
- d3-hierarchy tree layout with vertical top-down rendering
- Probability-sized nodes colored by affirmative/negative
- Evidence sidebar with source cards showing descriptions, confidence, GDELT IDs
- Modal opens from forecast click, closes via Escape/backdrop/X
</success_criteria>

<output>
After completion, create `.planning/phases/12-wm-derived-frontend/12-05-SUMMARY.md`
</output>
