---
phase: 12-wm-derived-frontend
plan: 07
type: execute
wave: 5
depends_on: ["12-01", "12-02", "12-03", "12-04", "12-05", "12-06"]
files_modified:
  - frontend/src/main.ts
  - frontend/src/app/panel-layout.ts
  - frontend/src/styles/main.css
  - frontend/src/styles/panels.css
autonomous: false

must_haves:
  truths:
    - "Dashboard loads showing globe in center with panels arranged around it in a grid"
    - "All 6 panels render data from the API (or show loading/placeholder states)"
    - "Globe shows countries colored by risk score"
    - "Clicking a forecast card opens ScenarioExplorer modal"
    - "Clicking a country on globe opens Country Brief modal"
    - "Theme toggle switches dark/light across all panels, map, and modals"
    - "RefreshScheduler periodically updates panel data"
    - "API failures show stale data with 'unavailable' badge, not a broken UI"
  artifacts:
    - path: "frontend/src/main.ts"
      provides: "Bootstrap that creates all panels, map, modals, and wires refresh"
      min_lines: 80
    - path: "frontend/src/app/panel-layout.ts"
      provides: "Panel grid layout manager with resize support"
      contains: "createPanelLayout"
  key_links:
    - from: "frontend/src/main.ts"
      to: "frontend/src/components/DeckGLMap.ts"
      via: "creates and initializes globe"
      pattern: "DeckGLMap"
    - from: "frontend/src/main.ts"
      to: "frontend/src/components/ForecastPanel.ts"
      via: "creates panel instances"
      pattern: "ForecastPanel"
    - from: "frontend/src/main.ts"
      to: "frontend/src/app/refresh-scheduler.ts"
      via: "registers panel refresh functions"
      pattern: "RefreshScheduler"
    - from: "frontend/src/main.ts"
      to: "frontend/src/components/ScenarioExplorer.ts"
      via: "creates modal instance"
      pattern: "ScenarioExplorer"
    - from: "frontend/src/main.ts"
      to: "frontend/src/components/CountryBriefPage.ts"
      via: "creates modal instance"
      pattern: "CountryBriefPage"
---

<objective>
Wire everything together: update main.ts to create all panels, initialize the globe, register data refresh, and connect all event flows. Create the panel-layout manager. Polish CSS. Then verify the complete dashboard works end-to-end with a human checkpoint.

Purpose: This is the integration plan -- all individual components (Plans 01-06) exist but aren't connected. This plan boots the complete dashboard and verifies it with user inspection.

Output: Fully integrated dashboard with all panels, globe, modals, and data refresh running.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/12-wm-derived-frontend/12-CONTEXT.md
@.planning/phases/12-wm-derived-frontend/12-RESEARCH.md
@.planning/phases/12-wm-derived-frontend/12-01-SUMMARY.md
@.planning/phases/12-wm-derived-frontend/12-02-SUMMARY.md
@.planning/phases/12-wm-derived-frontend/12-03-SUMMARY.md
@.planning/phases/12-wm-derived-frontend/12-04-SUMMARY.md
@.planning/phases/12-wm-derived-frontend/12-05-SUMMARY.md
@.planning/phases/12-wm-derived-frontend/12-06-SUMMARY.md

# All component files to wire:
@frontend/src/components/DeckGLMap.ts
@frontend/src/components/ForecastPanel.ts
@frontend/src/components/RiskIndexPanel.ts
@frontend/src/components/EventTimelinePanel.ts
@frontend/src/components/EnsembleBreakdownPanel.ts
@frontend/src/components/SystemHealthPanel.ts
@frontend/src/components/CalibrationPanel.ts
@frontend/src/components/ScenarioExplorer.ts
@frontend/src/components/CountryBriefPage.ts
@frontend/src/services/forecast-client.ts
@frontend/src/app/app-context.ts
@frontend/src/app/refresh-scheduler.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Panel layout manager + main.ts integration + CSS polish</name>
  <files>
    frontend/src/app/panel-layout.ts
    frontend/src/main.ts
    frontend/src/styles/main.css
    frontend/src/styles/panels.css
  </files>
  <action>
    **panel-layout.ts** (~80-120 lines):
    Read WM's panel-layout.ts for the pattern. Create a simplified version for Geopol's fixed-position grid:

    - `createPanelLayout(container: HTMLElement): Record<string, HTMLElement>`: Creates the grid DOM structure
    - Layout: 3 columns, defined row areas
    - Grid areas (using CSS Grid named areas):
      ```
      "forecasts    map         risk-index"
      "forecasts    map         risk-index"
      "ensemble     map         health"
      "calibration  events      health"
      ```
    - Left column: ForecastPanel (top, spans 2 rows) + EnsembleBreakdownPanel + CalibrationPanel
    - Center: DeckGLMap (spans 3 rows)
    - Right column: RiskIndexPanel (top, spans 2 rows) + SystemHealthPanel (spans 2 rows)
    - Bottom center: EventTimelinePanel
    - Return a Record mapping panel id -> container HTMLElement
    - Grid proportions: left 25%, center 50%, right 25%
    - Resizable panel borders (use Panel base class resize handles)

    **main.ts** (~120-160 lines): Complete rewrite of the stub from Plan 01. Bootstrap sequence:

    1. Import styles: main.css, panels.css
    2. Import applyStoredTheme and call it (FOUC prevention -- but index.html inline script handles this)
    3. Import all components and services
    4. Wait for DOMContentLoaded
    5. Create the #app container and panel grid:
       ```typescript
       const container = document.getElementById('app')!;
       const slots = createPanelLayout(container);
       ```
    6. Create AppContext:
       ```typescript
       const ctx = createAppContext(container);
       ```
    7. Initialize services:
       - `countryGeometry.load()` (async, load GeoJSON)
    8. Create all 6 panels and mount to slots:
       ```typescript
       const forecastPanel = new ForecastPanel();
       slots['forecasts'].appendChild(forecastPanel.el);
       ctx.panels['forecasts'] = forecastPanel;
       // ... repeat for all 6 panels
       ```
    9. Create DeckGLMap in the center slot:
       ```typescript
       const map = new DeckGLMap(slots['map']);
       ctx.map = map;
       ```
    10. Create modals (append to body, hidden initially):
        ```typescript
        const scenarioExplorer = new ScenarioExplorer();
        const countryBriefPage = new CountryBriefPage();
        ```
    11. Wire data flow -- initial load + event handlers. Use `update(data)` for panels (NOT `refresh()`), because main.ts fetches data once and distributes to multiple consumers:
        ```typescript
        const forecasts = await forecastClient.getTopForecasts(10);
        forecastPanel.update(forecasts);
        ctx.forecasts = forecasts;

        const countries = await forecastClient.getCountries();
        riskIndexPanel.update(countries);
        ctx.countries = countries;
        map.updateRiskScores(new Map(countries.map(c => [c.iso_code, c.risk_score])));
        map.updateForecasts(forecasts);

        const health = await forecastClient.getHealth();
        systemHealthPanel.update(health);
        ```
        - Wire 'forecast-selected' event: update EnsembleBreakdownPanel via `ensemblePanel.update(forecast)` and CalibrationPanel via `calibrationPanel.update([forecast.calibration])` with selected forecast's data
        - Wire 'country-selected' event: update map highlight + open CountryBriefPage
    12. Set up RefreshScheduler. Use `refresh()` for scheduler callbacks (panels self-fetch on timer):
        ```typescript
        const scheduler = new RefreshScheduler();
        scheduler.register([
          { name: 'forecasts', fn: async () => { forecastPanel.refresh(); }, intervalMs: 60_000 },
          { name: 'countries', fn: async () => { riskIndexPanel.refresh(); }, intervalMs: 120_000 },
          { name: 'health', fn: async () => { systemHealthPanel.refresh(); }, intervalMs: 30_000 },
        ]);
        scheduler.start();
        ```
    13. Add theme toggle button to header bar (or corner of page):
        - Button with sun/moon icon
        - onClick: call setTheme() (toggles dark/light)
    14. Mark initialLoadComplete, log "Geopol dashboard ready"

    **Key distinction -- refresh() vs update(data):**
    - `update(data)`: Used in step 11 for initial load and event-driven updates. main.ts fetches data once and pushes to multiple panels/map. Avoids redundant API calls.
    - `refresh()`: Used in step 12 for scheduler. Each panel self-fetches independently on its own timer. Decouples scheduled updates from main.ts coordination.

    **CSS updates:**
    - Finalize grid layout in main.css: grid-template-areas, column/row sizing
    - Ensure panels fill their grid slots properly
    - Add header bar styling (thin bar at top with logo text "GEOPOL" and theme toggle)
    - Responsive: on narrow screens (<1200px), stack panels vertically with map full-width on top
    - Polish panel spacing, borders, shadows
    - Ensure modals layer correctly (z-index stacking)
    - Add maplibre-gl CSS import (maplibre-gl/dist/maplibre-gl.css) -- required for map rendering

    **Critical wiring to get right:**
    - CountryBriefPage listens for 'country-selected' CustomEvent (dispatched by DeckGLMap onClick and RiskIndexPanel onClick)
    - ScenarioExplorer listens for 'forecast-selected' CustomEvent (dispatched by ForecastPanel onClick and CountryBriefPage forecast card onClick)
    - Theme toggle dispatches 'theme-changed' CustomEvent (DeckGLMap listens to rebuild layers)
    - EnsembleBreakdownPanel.update(forecast) when a forecast is selected (via same 'forecast-selected' event)
    - CalibrationPanel.update(calibrations) from selected forecast's calibration data

    Ensure all event listeners are properly set up and there are no circular dependencies.
  </action>
  <verify>
    `cd frontend && npx tsc --noEmit` passes.
    `cd frontend && npx vite build` succeeds.
    `cd frontend && npx vite` starts dev server.
    Open browser: dashboard loads with panels and globe visible.
  </verify>
  <done>
    main.ts creates all 6 panels, globe, and 2 modals.
    Panel grid layout arranges components in 3-column grid.
    Initial data load uses update(data) to push to panels and map.
    RefreshScheduler uses refresh() for periodic self-fetch updates.
    Event wiring connects globe clicks -> CountryBriefPage, forecast clicks -> ScenarioExplorer.
    Theme toggle works across all components.
    `npx vite build` succeeds.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete Geopol dashboard frontend:
    - deck.gl globe with 5 map layers (risk choropleth, forecast markers, KG arcs, GDELT heatmap, scenario zones)
    - 6 dashboard panels: ForecastPanel, RiskIndexPanel, EventTimelinePanel, EnsembleBreakdownPanel, SystemHealthPanel, CalibrationPanel
    - ScenarioExplorer modal with d3 tree visualization + evidence sidebar
    - Country Brief Page with 7 tabs (Overview, Active Forecasts, GDELT Events, Risk Signals, Forecast History, Entity Relations, Calibration)
    - Dark/light theme with intelligence/analyst aesthetic
    - Circuit breaker resilience on API calls
    - All built with vanilla TypeScript (no framework), WM-derived patterns
  </what-built>
  <how-to-verify>
    Prerequisites: Start the FastAPI backend (`cd /home/kondraki/personal/geopol && uv run uvicorn src.api.app:app --reload`), then start the frontend (`cd frontend && npx vite`).

    If backend is not available, the dashboard should still load with circuit breaker showing "unavailable" badges (FE-08 requirement).

    1. Open the dashboard URL (likely http://localhost:5173)
    2. Verify: Dark-themed shell loads with globe in center, panels arranged around it
    3. Verify: Globe shows countries colored by risk (blue to red)
    4. Verify: ForecastPanel on the left shows forecast cards with probability bars
    5. Verify: RiskIndexPanel on the right shows countries with risk scores and trend arrows
    6. Verify: Click a forecast card -> ScenarioExplorer modal opens with scenario tree
    7. Verify: In ScenarioExplorer, click a tree node -> evidence sidebar populates
    8. Verify: Close ScenarioExplorer (Escape or X)
    9. Verify: Click a country on the globe -> Country Brief modal opens with 7 tabs
    10. Verify: Country Brief has tabs, switch between them -- check Risk Signals tab shows CAMEO categories
    11. Verify: Click theme toggle -> light theme, colors update across everything including globe
    12. Verify: Toggle back to dark theme
    13. Verify: Layer toggle panel on globe allows toggling map layers on/off
    14. Verify: If API is unreachable, panels show "unavailable" indicator (not crash/blank)

    Report any visual issues, broken interactions, or TypeScript errors in console.
  </how-to-verify>
  <resume-signal>Type "approved" to complete Phase 12, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
- `cd frontend && npx tsc --noEmit` passes
- `cd frontend && npx vite build` succeeds
- Dashboard loads in browser with all components visible
- All 8 success criteria from the roadmap are satisfied
- Globe, panels, modals, and theme toggle all functional
</verification>

<success_criteria>
- SC-1: Globe with ForecastRiskChoropleth + 3 additional toggleable layers
- SC-2: ForecastPanel with question, probability, confidence, scenario count, timestamp
- SC-3: ScenarioExplorer with interactive tree, evidence sidebar
- SC-4: Country Brief with 7 tabs populated from API (including Risk Signals)
- SC-5: RiskIndexPanel with trend indicators
- SC-6: CalibrationPanel with reliability diagram + Brier decomposition + track record sparkline
- SC-7: Dark/light theme toggle with consistent severity colors
- SC-8: Circuit breaker stale-data display on API failure
</success_criteria>

<output>
After completion, create `.planning/phases/12-wm-derived-frontend/12-07-SUMMARY.md`
</output>
