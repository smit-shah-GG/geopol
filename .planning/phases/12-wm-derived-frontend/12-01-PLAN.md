---
phase: 12-wm-derived-frontend
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/index.html
  - frontend/vite.config.ts
  - frontend/tsconfig.json
  - frontend/package.json
  - frontend/src/main.ts
  - frontend/src/types/api.ts
  - frontend/src/types/index.ts
  - frontend/src/app/app-context.ts
  - frontend/src/app/refresh-scheduler.ts
  - frontend/src/components/Panel.ts
  - frontend/src/utils/dom-utils.ts
  - frontend/src/utils/theme-manager.ts
  - frontend/src/utils/theme-colors.ts
  - frontend/src/utils/sanitize.ts
  - frontend/src/styles/main.css
  - frontend/src/styles/panels.css
autonomous: true

must_haves:
  truths:
    - "`npm run dev` in frontend/ starts Vite dev server without errors"
    - "Browser loads index.html showing an empty dark-themed shell with panel grid placeholders"
    - "Dark/light theme toggle switches CSS variables and persists to localStorage"
    - "TypeScript strict mode compiles with zero errors"
  artifacts:
    - path: "frontend/package.json"
      provides: "npm project with deck.gl, maplibre-gl, d3 dependencies"
      contains: "deck.gl"
    - path: "frontend/vite.config.ts"
      provides: "Vite build config with API proxy and manual chunks"
      contains: "manualChunks"
    - path: "frontend/tsconfig.json"
      provides: "Strict TypeScript config with path aliases"
      contains: "noUncheckedIndexedAccess"
    - path: "frontend/src/types/api.ts"
      provides: "TypeScript interfaces mirroring all Pydantic DTOs"
      contains: "ForecastResponse"
    - path: "frontend/src/components/Panel.ts"
      provides: "Panel base class with resize, loading, error, data badge"
      contains: "class Panel"
    - path: "frontend/src/utils/dom-utils.ts"
      provides: "h() hyperscript helper and DOM utilities"
      contains: "function h("
    - path: "frontend/src/styles/main.css"
      provides: "CSS variables for intelligence/analyst aesthetic"
      contains: "--bg"
  key_links:
    - from: "frontend/src/main.ts"
      to: "frontend/src/app/app-context.ts"
      via: "import and initialization"
      pattern: "import.*app-context"
    - from: "frontend/src/main.ts"
      to: "frontend/src/utils/theme-manager.ts"
      via: "applyStoredTheme() call"
      pattern: "applyStoredTheme"
    - from: "frontend/src/components/Panel.ts"
      to: "frontend/src/utils/dom-utils.ts"
      via: "h() import for DOM construction"
      pattern: "import.*dom-utils"
---

<objective>
Create the frontend project scaffold: Vite build system, TypeScript config, Panel base class, AppContext singleton, h() DOM helper, theme system (CSS variables + manager), API type definitions, and a minimal main.ts that boots the dark-themed shell.

Purpose: Every subsequent plan depends on these foundational files. This is the "fork that isn't a fork" -- WM's architectural patterns carried wholesale with all WM-specific content stripped.

Output: A `frontend/` directory that compiles, runs `npm run dev`, and shows an empty dark dashboard shell in the browser.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/12-wm-derived-frontend/12-CONTEXT.md
@.planning/phases/12-wm-derived-frontend/12-RESEARCH.md

# WM source files to carry (read these, strip WM-specific code, adapt for Geopol):
@/home/kondraki/personal/worldmonitor/src/components/Panel.ts
@/home/kondraki/personal/worldmonitor/src/utils/dom-utils.ts
@/home/kondraki/personal/worldmonitor/src/utils/theme-manager.ts
@/home/kondraki/personal/worldmonitor/src/utils/theme-colors.ts
@/home/kondraki/personal/worldmonitor/src/app/app-context.ts
@/home/kondraki/personal/worldmonitor/src/app/refresh-scheduler.ts

# Pydantic DTOs to mirror in TypeScript:
@src/api/schemas/forecast.py
@src/api/schemas/country.py
@src/api/schemas/health.py
@src/api/schemas/common.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Project scaffold + build system + TypeScript types</name>
  <files>
    frontend/package.json
    frontend/vite.config.ts
    frontend/tsconfig.json
    frontend/index.html
    frontend/src/types/api.ts
    frontend/src/types/index.ts
  </files>
  <action>
    Create the `frontend/` directory at project root.

    **package.json**: Initialize with these exact dependencies (pin to WM's versions):
    - deck.gl: ^9.2.6
    - @deck.gl/core: ^9.2.6
    - @deck.gl/layers: ^9.2.6
    - @deck.gl/aggregation-layers: ^9.2.6
    - @deck.gl/mapbox: ^9.2.6
    - maplibre-gl: ^5.16.0
    - d3: ^7.9.0
    DevDependencies:
    - typescript: ^5.7.2
    - vite: ^6.0.7
    - @types/d3: latest
    Scripts: "dev": "vite", "build": "tsc && vite build", "preview": "vite preview"

    **vite.config.ts**: Derived from WM (see 12-RESEARCH.md Vite Config section). Include:
    - `@` path alias resolving to `src/`
    - Build target es2020, sourcemaps enabled
    - Manual chunks: deckgl, maplibre, d3 (separate vendor bundles)
    - Dev server proxy: `/api` -> `http://localhost:8000` (FastAPI backend)

    **tsconfig.json**: Copy from 12-RESEARCH.md exactly. Strict mode, noUncheckedIndexedAccess, `@/*` path alias, bundler module resolution.

    **index.html**: Single entry point. Include:
    - Inline `<script>` in `<head>` for FOUC-free theme initialization (read localStorage before first paint, set `data-theme` attribute on `<html>`)
    - `<div id="app">` container
    - `<script type="module" src="/src/main.ts">` entry
    - Meta viewport for responsive
    - Title: "Geopol - Geopolitical Forecast Dashboard"

    **src/types/api.ts**: Create TypeScript interfaces mirroring ALL Pydantic DTOs from `src/api/schemas/`. Keep snake_case field names to match JSON wire format exactly. Read each Pydantic schema file and mirror:
    - EvidenceDTO: source, description, confidence, timestamp (string|null), gdelt_event_id (string|null)
    - EnsembleInfoDTO: llm_probability, tkg_probability (number|null), weights (Record<string,number>), temperature_applied
    - CalibrationDTO: category, temperature, historical_accuracy, brier_score (number|null), sample_size
    - ScenarioDTO: scenario_id, description, probability, answers_affirmative, entities (string[]), timeline (string[]), evidence_sources (EvidenceDTO[]), child_scenarios (ScenarioDTO[]) -- recursive
    - ForecastResponse: forecast_id, question, prediction, probability, confidence, horizon_days, scenarios (ScenarioDTO[]), reasoning_summary, evidence_count, ensemble_info (EnsembleInfoDTO), calibration (CalibrationDTO), created_at (string), expires_at (string)
    - CountryRiskSummary: iso_code, risk_score, forecast_count, top_question, top_probability, trend ('rising'|'stable'|'falling'), last_updated (string)
    - SubsystemStatus: name, healthy, detail (string|null), checked_at (string)
    - HealthResponse: status ('healthy'|'degraded'|'unhealthy'), subsystems (SubsystemStatus[]), timestamp (string), version (string)
    - PaginatedResponse<T>: items (T[]), next_cursor (string|null), has_more (boolean)

    **src/types/index.ts**: Re-export all types from api.ts.

    Run `cd frontend && npm install` to install dependencies.
  </action>
  <verify>
    `cd frontend && npx tsc --noEmit` exits 0 (no TypeScript errors).
    `ls frontend/node_modules/deck.gl` confirms deck.gl installed.
  </verify>
  <done>
    frontend/ directory exists with package.json, vite.config.ts, tsconfig.json, index.html.
    TypeScript interfaces in api.ts exactly mirror all Pydantic DTOs with snake_case fields.
    `npm install` completes, `tsc --noEmit` passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Panel base class + DOM utils + theme system + AppContext + main.ts</name>
  <files>
    frontend/src/components/Panel.ts
    frontend/src/utils/dom-utils.ts
    frontend/src/utils/theme-manager.ts
    frontend/src/utils/theme-colors.ts
    frontend/src/utils/sanitize.ts
    frontend/src/app/app-context.ts
    frontend/src/app/refresh-scheduler.ts
    frontend/src/styles/main.css
    frontend/src/styles/panels.css
    frontend/src/main.ts
  </files>
  <action>
    **dom-utils.ts**: Read `/home/kondraki/personal/worldmonitor/src/utils/dom-utils.ts` (147 lines). Carry wholesale -- this is framework-agnostic. Include h(), fragment(), replaceChildren(), rawHtml(), safeHtml(), text(), DomChild type, DomProps interface. No modifications needed.

    **theme-manager.ts**: Read `/home/kondraki/personal/worldmonitor/src/utils/theme-manager.ts` (85 lines). Carry wholesale. Change localStorage key from 'worldmonitor-theme' to 'geopol-theme'. Functions: getStoredTheme(), setTheme(), applyStoredTheme(). Dispatches 'theme-changed' CustomEvent.

    **theme-colors.ts**: Read `/home/kondraki/personal/worldmonitor/src/utils/theme-colors.ts` (31 lines). Carry wholesale. getCSSColor() with cache invalidation on theme change.

    **sanitize.ts**: Create with escapeHtml(str) and sanitizeUrl(url) functions. escapeHtml replaces &, <, >, ", '. sanitizeUrl rejects javascript: and data: protocols.

    **Panel.ts**: Read `/home/kondraki/personal/worldmonitor/src/components/Panel.ts` (458 lines). Adapt:
    - REMOVE: `import { isDesktopRuntime } from '../services/runtime'` and all isDesktopRuntime() calls
    - REMOVE: `import { invokeTauri } from '../services/tauri-bridge'` and all invokeTauri() calls
    - REMOVE: `import { t } from '../services/i18n'` -- replace t('...') with string literals
    - REMOVE: `import { trackPanelResized } from '@/services/analytics'` and all analytics calls
    - KEEP: PanelOptions interface (id, title, showCount, className, infoTooltip)
    - KEEP: constructor, this.el, this.header, this.content, this.resizeHandle
    - KEEP: showLoading(), showError(msg), setDataBadge(mode), setCount(n), setContent()
    - KEEP: Resize handle with span persistence to localStorage (change key from 'worldmonitor-panel-spans' to 'geopol-panel-spans')
    - KEEP: destroy() with AbortController cleanup
    - KEEP: heightToSpan(), setSpanClass(), loadPanelSpans(), savePanelSpan()

    **app-context.ts**: Create a stripped GeoPolAppContext interface and createAppContext() factory. Do NOT copy WM's 100+ field AppContext. Geopol needs:
    - map: DeckGLMap | null
    - container: HTMLElement
    - panels: Record<string, Panel>
    - forecasts: ForecastResponse[]
    - countries: CountryRiskSummary[]
    - healthStatus: HealthResponse | null
    - inFlight: Set<string>
    - selectedCountry: string | null
    - selectedForecast: ForecastResponse | null
    - scenarioExplorerOpen: boolean
    - countryBriefOpen: boolean
    - isDestroyed: boolean
    - initialLoadComplete: boolean

    **refresh-scheduler.ts**: Read `/home/kondraki/personal/worldmonitor/src/app/refresh-scheduler.ts` (108 lines). Adapt the interface -- the WM version depends on WM's AppContext type. Create a Geopol-specific version that:
    - Accepts RefreshRegistration[] (name, fn, intervalMs, condition?)
    - Uses setTimeout chains (not setInterval) to prevent overlap
    - Handles page visibility (pause when hidden, catch-up when visible)
    - Has destroy() for cleanup

    **main.css**: Create the intelligence/analyst aesthetic CSS. This is NOT a copy of WM's 15K-line main.css. Build a new, focused stylesheet (~300-400 lines):
    - `:root` (dark theme default): `--bg: #0a0e14`, `--bg-secondary: #0d1117`, `--surface: #111922`, `--surface-hover: #1a2332`, `--surface-active: #243044`, `--border: #1e2d3d`, `--border-strong: #30445a`, `--border-subtle: #141e2a`
    - Text hierarchy: `--text: #e6edf3`, `--text-secondary: #b0bec5`, `--text-dim: #7a8a99`, `--text-muted: #4a5568`, `--text-faint: #2d3748`, `--text-ghost: #1a2332`
    - Semantic severity: `--semantic-critical: #ff4444`, `--semantic-high: #ff8800`, `--semantic-elevated: #ffaa00`, `--semantic-normal: #44aa44`, `--semantic-low: #3388ff`
    - Accent: `--accent-primary: #00d4ff`, `--accent-secondary: #0099cc`
    - Typography: `--font-mono: 'SF Mono', Monaco, 'Cascadia Code', 'Fira Code', 'DejaVu Sans Mono', monospace`, `--font-sans: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif`
    - `[data-theme="light"]` overrides: lighter backgrounds, darker text, adjusted severity colors
    - Base layout: `#app` fills viewport, panel grid uses CSS Grid
    - Body: `margin: 0`, `background: var(--bg)`, `color: var(--text)`, `font-family: var(--font-mono)`, `font-size: 13px`
    - Panel grid: `display: grid`, `grid-template-columns: 1fr 2fr 1fr`, `grid-template-rows` with named areas
    - Panel base styles: `.panel` with surface background, border, overflow hidden
    - Panel header: `.panel-header` with uppercase title, monospace, letter-spacing
    - Panel loading/error/data-badge states
    - Resize handle styles
    - Scrollbar styling (thin, dark)
    - Map container: `#map-container` fills the center grid area

    **panels.css**: Panel-specific style overrides (~50-100 lines). Risk score colors, forecast cards, etc. Can be mostly empty initially -- panels will add their own styles.

    **main.ts**: Bootstrap script:
    1. Import and call applyStoredTheme()
    2. Import styles (main.css, panels.css)
    3. Create app container DOM structure with panel grid layout
    4. Call createAppContext() with the container element
    5. Add a theme toggle button (sun/moon icon) in a header bar
    6. Log "Geopol dashboard initialized" to console
    7. For now, create placeholder div elements in the grid slots where panels will go (shows the dark shell is working)

    Do NOT install additional npm packages. Do NOT create panel implementations beyond Panel.ts base class.
  </action>
  <verify>
    `cd frontend && npx tsc --noEmit` exits 0.
    `cd frontend && npx vite build` completes without errors.
    `cd frontend && npx vite --host 0.0.0.0 &` then open browser -- dark-themed shell visible with empty grid.
    Theme toggle switches between dark and light.
  </verify>
  <done>
    Panel base class exists with resize, loading, error, data badge functionality (WM-derived, Geopol-adapted).
    h() helper, theme manager, theme colors, sanitize utils all present.
    AppContext interface defined with Geopol-specific fields.
    RefreshScheduler adapted for Geopol's simpler context.
    CSS variables implement intelligence/analyst aesthetic (dark default).
    main.ts boots the dashboard shell, theme toggle works.
    `npx vite build` succeeds.
  </done>
</task>

</tasks>

<verification>
- `cd frontend && npm install && npx tsc --noEmit` passes
- `cd frontend && npx vite build` produces dist/ output
- `cd frontend && npx vite` starts dev server
- Browser shows dark-themed shell with panel grid
- Theme toggle switches dark/light and persists across reload
- api.ts types match every field in the Pydantic schemas (snake_case)
</verification>

<success_criteria>
- frontend/ directory with complete build system
- TypeScript strict mode, zero compile errors
- All Pydantic DTOs mirrored in TypeScript
- Panel base class with full WM lifecycle (resize, loading, error, data badge)
- Intelligence/analyst dark theme with CSS variables
- Empty shell visible in browser
</success_criteria>

<output>
After completion, create `.planning/phases/12-wm-derived-frontend/12-01-SUMMARY.md`
</output>
