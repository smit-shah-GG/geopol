---
phase: 06-networkx-fix
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/knowledge_graph/temporal_index.py
  - src/knowledge_graph/test_temporal_index.py
autonomous: true

must_haves:
  truths:
    - "shortest_path method returns valid path list for connected nodes without raising TypeError"
    - "shortest_path method returns None for disconnected nodes without raising unhandled exceptions"
    - "shortest_path method respects max_length constraint, returning None when shortest path exceeds cutoff"
    - "All existing tests pass without modification (except the shortest_path test which is updated)"
  artifacts:
    - path: "src/knowledge_graph/temporal_index.py"
      provides: "Fixed shortest_path method using nx.single_source_shortest_path"
      contains: "single_source_shortest_path"
    - path: "src/knowledge_graph/test_temporal_index.py"
      provides: "Updated test covering connected, disconnected, and max_length-exceeded cases"
      contains: "single_source_shortest_path"
  key_links:
    - from: "src/knowledge_graph/temporal_index.py:shortest_path"
      to: "nx.single_source_shortest_path"
      via: "API call with cutoff parameter"
      pattern: "nx\\.single_source_shortest_path\\(self\\.graph,\\s*source,\\s*cutoff=max_length\\)"
---

<objective>
Fix the broken NetworkX API call in `TemporalIndex.shortest_path` that passes an invalid `cutoff` parameter to `nx.shortest_path`.

Purpose: `nx.shortest_path` does not accept `cutoff`. The code must use `nx.single_source_shortest_path(G, source, cutoff=max_length)` which returns a dict of reachable paths, then extract the target path. Exception handling must also change: `single_source_shortest_path` signals "no path" via absent dict key, not `NetworkXNoPath`.

Output: Fixed `temporal_index.py` and updated `test_temporal_index.py` with assertions covering the connected, disconnected, and cutoff-exceeded cases.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/knowledge_graph/temporal_index.py
@src/knowledge_graph/test_temporal_index.py
@.planning/phases/06-networkx-fix/06-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix NetworkX API call in TemporalIndex.shortest_path</name>
  <files>src/knowledge_graph/temporal_index.py</files>
  <action>
Replace the `shortest_path` method body (lines 220-236) with:

1. Call `nx.single_source_shortest_path(self.graph, source, cutoff=max_length)` which returns a dict mapping reachable nodes to their paths, bounded by `cutoff` hops.
2. Look up `target` in the returned dict. If present, return the path list. If absent (target unreachable or beyond cutoff), return `None`.
3. Remove the `try/except nx.NetworkXNoPath` block — `single_source_shortest_path` does not raise that exception. Instead, catch `nx.NodeNotFound` for the case where `source` itself is not in the graph (preserves defensive behavior).

The method signature (`source, target, max_length=5`) and return type (`Optional[List]`) remain unchanged. No downstream callers need modification.
  </action>
  <verify>
Run: `cd /home/kondraki/personal/geopol && python -c "import networkx as nx; G = nx.MultiDiGraph(); G.add_edge('A','B'); G.add_edge('B','C'); paths = nx.single_source_shortest_path(G, 'A', cutoff=2); assert paths.get('C') == ['A','B','C']; assert paths.get('Z') is None; print('API verified')"` — prints "API verified" without error.
  </verify>
  <done>
`TemporalIndex.shortest_path` uses `nx.single_source_shortest_path` with `cutoff=max_length`. No reference to the old `nx.shortest_path(..., cutoff=...)` pattern remains in the file.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update test_shortest_path to cover connected, disconnected, and cutoff cases</name>
  <files>src/knowledge_graph/test_temporal_index.py</files>
  <action>
Replace `test_shortest_path` (lines 154-159) with three focused tests:

1. `test_shortest_path_connected`: Add an edge chain in the sample graph fixture or use existing connectivity. Assert the method returns a non-None list for nodes known to be connected within max_length.

2. `test_shortest_path_disconnected`: Query two nodes with no path between them (e.g., 'NATO' has no outgoing edges in sample data, so `shortest_path('NATO', 'CHN')` should return `None`).

3. `test_shortest_path_cutoff_exceeded`: Query two nodes that ARE connected but set `max_length=1` when the actual shortest path is longer than 1 hop. Assert the method returns `None` because the cutoff is too short. This validates the `max_length` constraint is enforced (the entire reason for BUG-01).

For connectivity: the sample graph has `USA -> CHN` (direct, 1 hop) and `RUS -> UKR` (direct, 1 hop), but no multi-hop paths. To test cutoff, either:
- Add edges to the sample fixture (e.g., `USA -> EU`, `EU -> NATO`) to create a 2-hop path, OR
- Create a local graph in the test method.

Prefer creating a local graph in the cutoff test to avoid perturbing other tests that assert specific edge counts.
  </action>
  <verify>
Run: `cd /home/kondraki/personal/geopol && python -m pytest src/knowledge_graph/test_temporal_index.py -v --tb=short` — all tests pass, including the three new shortest_path tests.
  </verify>
  <done>
Three test methods exist covering connected path, disconnected path, and cutoff-exceeded. All pass. The old `test_shortest_path` with its vague "may be None" comment is gone.
  </done>
</task>

</tasks>

<verification>
1. `python -m pytest src/knowledge_graph/test_temporal_index.py -v --tb=short` — all tests pass
2. `grep -n "nx.shortest_path" src/knowledge_graph/temporal_index.py` — returns NO matches (old API gone)
3. `grep -n "single_source_shortest_path" src/knowledge_graph/temporal_index.py` — returns match on the fixed line
4. `grep -n "cutoff" src/knowledge_graph/temporal_index.py` — confirms cutoff is passed to the correct function
</verification>

<success_criteria>
- Zero test failures in `test_temporal_index.py`
- `nx.shortest_path(..., cutoff=...)` pattern eliminated from codebase
- `nx.single_source_shortest_path` used with `cutoff=max_length`
- Test coverage includes connected, disconnected, and cutoff-exceeded scenarios
- Method signature and return type unchanged (no downstream breakage)
</success_criteria>

<output>
After completion, create `.planning/phases/06-networkx-fix/06-01-SUMMARY.md`
</output>
